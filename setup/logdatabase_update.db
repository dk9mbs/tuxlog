

DROP PROCEDURE IF EXISTS proc_install_upd20190804;
DELIMITER //
CREATE PROCEDURE proc_install_upd20190804
()
BEGIN
    call proc_printf('installing upd20190804 ...');
    IF NOT EXISTS (SELECT id FROM log_modes WHERE id='FT8') THEN 
        INSERT INTO log_modes (id,description) values ('FT8','FT8');
    END IF;
    IF NOT EXISTS (SELECT id FROM log_modes WHERE id='FT4') THEN 
        INSERT INTO log_modes (id,description) values ('FT4','FT4');
    END IF;
    IF NOT EXISTS (SELECT version FROM meta_sys_dbversion WHERE version='upd20190804') THEN 
        INSERT INTO meta_sys_dbversion(version,description) VALUES ('upd20190804','upd20190804');
    END IF;
    IF NOT EXISTS (select COLUMN_NAME from INFORMATION_SCHEMA.columns WHERE TABLE_SCHEMA=DATABASE() 
        AND TABLE_NAME='log_rigs' AND column_name='remote_host') THEN
            ALTER TABLE log_rigs add column remote_host varchar(250) NOT NULL default '127.0.0.1';
            ALTER TABLE log_rigs add column remote_port int NOT NULL default '4532';
    END IF;

    call proc_printf('upd20190804 installed!');

END //
DELIMITER ;



DROP PROCEDURE IF EXISTS proc_install_upd20190825;
DELIMITER //
CREATE PROCEDURE proc_install_upd20190825
()
BEGIN
    call proc_printf('installing upd20190825 ...');

    UPDATE meta_data_exchange_fields SET internal_fieldname='power' 
        where external_fieldname='tx_pwr' and 
        (internal_fieldname='' OR internal_fieldname IS NULL);



    IF NOT EXISTS (select COLUMN_NAME from INFORMATION_SCHEMA.columns WHERE TABLE_SCHEMA=DATABASE() 
        AND TABLE_NAME='log_rigs' AND column_name='remote_host') THEN
            ALTER TABLE log_rigs add column remote_host varchar(250) NOT NULL default '127.0.0.1';
            ALTER TABLE log_rigs add column remote_port int NOT NULL default '4532';
    END IF;



    IF NOT EXISTS (SELECT version FROM meta_sys_dbversion WHERE version='upd20190825') THEN 
        INSERT INTO meta_sys_dbversion(version,description) VALUES ('upd20190825','upd20190825');
    END IF;


    call proc_printf('upd20190825 installed!');

END //
DELIMITER ;



DROP PROCEDURE IF EXISTS proc_install_upd20190903;
DELIMITER //
CREATE PROCEDURE proc_install_upd20190903
()
BEGIN
    call proc_printf('installing upd20190903 ...');

    delete from meta_dataviews;
    delete from meta_dataforms;

    IF NOT EXISTS (select id from meta_dataviews where model_name='LogLogs') THEN
        INSERT INTO meta_dataviews (model_name, view_name, fields, where_clause,filter_clause, id_field_name, open_path, order_by) VALUES (
            'LogRigs', 'default', '["id","description", "hamlib_id","remote_host","remote_port"]', 
                '','description like \'$1\'','id','/ui/dataform/LogRigs/default/$1','description');


        INSERT INTO meta_dataviews (model_name, view_name, fields, where_clause,filter_clause, id_field_name, open_path, order_by) VALUES (
            'LogLogbooks', 'default', '["id","mycall","description"]', 
                '','description like \'$1\'','id','/ui/dataform/LogLogbooks/default/$1','description');

        INSERT INTO meta_dataviews (model_name, view_name, fields, where_clause,filter_clause, id_field_name, open_path, order_by) VALUES (
            'LogModes', 'default', '["id","description"]', 
                '','description like \'$1\'','id','/ui/dataform/LogModes/default/$1','description');

        INSERT INTO meta_dataviews (model_name, view_name, fields, where_clause,filter_clause, id_field_name, open_path, order_by) VALUES (
            'LogQslshipmentmodes', 'default', '["id","description"]', 
                '','description like \'$1\'','id','/ui/dataform/LogQslshipmentmodes/default/$1','description');

        INSERT INTO meta_dataviews (model_name, view_name, fields, where_clause,filter_clause, id_field_name, open_path, order_by) VALUES (
            'LogDxcc', 'default', '["id","entity_name"]', 
                '','description like \'$1\'','id','/ui/dataform/LogDxcc/default/$1','entity_name');

    END IF;


    IF NOT EXISTS (select id from meta_dataforms where model_name='LogRigs' and form_name='default') THEN
        INSERT INTO meta_dataforms(model_name,form_name, datacomponent) VALUES (
            'LogRigs','default','tuxlog-rig'
        );
        INSERT INTO meta_dataforms(model_name,form_name, datacomponent) VALUES (
            'LogLogbooks','default','tuxlog-logbook'
        );
        INSERT INTO meta_dataforms(model_name,form_name, datacomponent) VALUES (
            'LogModes','default','tuxlog-mode'
        );
        INSERT INTO meta_dataforms(model_name,form_name, datacomponent) VALUES (
            'LogQslshipmentmodes','default','tuxlog-qslshipmentmode'
        );

        INSERT INTO meta_dataforms(model_name,form_name, datacomponent) VALUES (
            'LogDxcc','default','tuxlog-dxcc'
        );

    END IF;


   IF NOT EXISTS (select COLUMN_NAME from INFORMATION_SCHEMA.columns WHERE TABLE_SCHEMA=DATABASE() 
        AND TABLE_NAME='log_logs' AND column_name='rxexchange1') THEN

        ALTER TABLE log_logs ADD rxexchange1 varchar(50) NULL COMMENT 'Contest exchange';
        ALTER TABLE log_logs ADD txexchange1 varchar(50) NULL COMMENT 'Contest exchange';

        ALTER TABLE log_logs ADD rxexchange2 varchar(50) NULL COMMENT 'Contest exchange 2';
        ALTER TABLE log_logs ADD txexchange2 varchar(50) NULL COMMENT 'Contest exchange 2';

    END IF;


    IF NOT EXISTS (SELECT version FROM meta_sys_dbversion WHERE version='upd20190903') THEN 
        INSERT INTO meta_sys_dbversion(version,description) VALUES ('upd20190903','upd20190903');
    END IF;


    call proc_printf('upd20190903 installed!');

END //
DELIMITER ;



call proc_install_upd20190804();
call proc_install_upd20190825();
call proc_install_upd20190903();

